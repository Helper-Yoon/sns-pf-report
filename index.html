<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNSì„¼í„° ë„ì›€ ì¹´ìš´íŒ… í”„ë¡œê·¸ë¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #000; color: #fff; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
        
        .header { text-align: center; margin-bottom: 50px; }
        .header h1 { font-size: 48px; font-weight: 200; margin-bottom: 10px; }
        .header h1 span { color: #1E6FFF; font-weight: 400; }
        .date-display { color: #666; font-size: 14px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; }
        .today-info { color: #1E6FFF; font-size: 18px; margin-top: 10px; }
        
        /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì¶”ê°€ */
        .progress-container { margin-bottom: 30px; padding: 20px; background: #111; border: 1px solid #222; display: none; }
        .progress-container.active { display: block; }
        .progress-title { font-size: 14px; color: #999; margin-bottom: 10px; }
        .progress-bar { width: 100%; height: 4px; background: #222; position: relative; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #1E6FFF, #00D4FF); transition: width 0.3s; }
        .progress-info { display: flex; justify-content: space-between; margin-top: 10px; font-size: 12px; color: #666; }
        
        .control-bar { display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background: #000; border: 1px solid #222; margin-bottom: 40px; flex-wrap: wrap; gap: 20px; }
        .control-buttons { display: flex; gap: 15px; }
        
        .btn { padding: 10px 25px; background: transparent; color: #666; border: 1px solid #333; font-size: 14px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; transition: all 0.3s; }
        .btn:hover { color: #1E6FFF; border-color: #1E6FFF; }
        .btn.primary { color: #1E6FFF; border-color: #1E6FFF; }
        .btn.primary:hover { background: #1E6FFF; color: #000; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .status-indicator { display: flex; align-items: center; gap: 10px; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #666; animation: pulse 2s infinite; }
        .status-dot.active { background: #00FF00; }
        .status-dot.loading { background: #1E6FFF; }
        .status-dot.error { background: #FF0000; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2px; margin-bottom: 50px; background: #111; padding: 2px; }
        .stat-card { background: #000; padding: 30px; text-align: center; position: relative; overflow: hidden; }
        .stat-card.updating::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #1E6FFF, transparent); animation: slide 1s infinite; }
        @keyframes slide { to { left: 100%; } }
        .stat-value { font-size: 48px; font-weight: 200; color: #1E6FFF; margin-bottom: 10px; }
        .stat-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 2px; }
        .stat-change { font-size: 13px; color: #00FF00; margin-top: 10px; }
        .stat-change.down { color: #FF0000; }
        
        .podium { display: flex; justify-content: center; align-items: flex-end; gap: 40px; margin-bottom: 60px; height: 400px; opacity: 0; transition: opacity 0.5s; }
        .podium.show { opacity: 1; }
        .podium-item { flex: 1; max-width: 280px; display: flex; flex-direction: column; align-items: center; position: relative; animation: fadeInUp 0.5s backwards; }
        .podium-item.rank-1 { animation-delay: 0.2s; }
        .podium-item.rank-2 { animation-delay: 0.1s; margin-top: 50px; }
        .podium-item.rank-3 { animation-delay: 0.3s; margin-top: 100px; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        .podium-rank { font-size: 60px; font-weight: 100; margin-bottom: 20px; opacity: 0.8; }
        .podium-item.rank-1 .podium-rank { color: #FFD700; opacity: 1; }
        .podium-item.rank-2 .podium-rank { color: #C0C0C0; }
        .podium-item.rank-3 .podium-rank { color: #CD7F32; }
        .podium-bar { width: 100%; background: #0a0a0a; border: 1px solid #222; position: relative; overflow: hidden; }
        .podium-item.rank-1 .podium-bar { height: 250px; border-color: #FFD700; background: linear-gradient(180deg, rgba(255,215,0,0.1), transparent); }
        .podium-item.rank-2 .podium-bar { height: 200px; border-color: #C0C0C0; background: linear-gradient(180deg, rgba(192,192,192,0.1), transparent); }
        .podium-item.rank-3 .podium-bar { height: 150px; border-color: #CD7F32; background: linear-gradient(180deg, rgba(205,127,50,0.1), transparent); }
        .podium-content { position: absolute; bottom: 20px; left: 0; right: 0; padding: 0 15px; text-align: center; }
        .podium-name { font-size: 18px; font-weight: 500; margin-bottom: 5px; }
        .podium-helps { font-size: 36px; font-weight: 200; color: #1E6FFF; }
        .podium-chars { font-size: 12px; color: #999; }
        
        .ranking-table { background: #000; border: 1px solid #222; margin-bottom: 40px; }
        .table-header { padding: 25px 30px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .table-title { font-size: 16px; font-weight: 300; letter-spacing: 1px; text-transform: uppercase; }
        .table-count { font-size: 12px; color: #666; }
        table { width: 100%; border-collapse: collapse; }
        th { padding: 20px; text-align: left; font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid #222; }
        td { padding: 20px; font-size: 15px; border-bottom: 1px solid #111; }
        tr { opacity: 0; animation: fadeIn 0.3s forwards; }
        tr:nth-child(1) { animation-delay: 0.05s; }
        tr:nth-child(2) { animation-delay: 0.1s; }
        tr:nth-child(3) { animation-delay: 0.15s; }
        tr:nth-child(4) { animation-delay: 0.2s; }
        tr:nth-child(5) { animation-delay: 0.25s; }
        @keyframes fadeIn { to { opacity: 1; } }
        tr:hover { background: #050505; }
        tr.new-entry { animation: highlight 1s; }
        @keyframes highlight { 0% { background: rgba(30,111,255,0.2); } 100% { background: transparent; } }
        
        .rank-number { display: inline-block; width: 32px; height: 32px; line-height: 32px; text-align: center; font-size: 16px; color: #666; }
        .rank-number.gold { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; border-radius: 50%; }
        .rank-number.silver { background: linear-gradient(135deg, #C0C0C0, #808080); color: #000; border-radius: 50%; }
        .rank-number.bronze { background: linear-gradient(135deg, #CD7F32, #8B4513); color: #fff; border-radius: 50%; }
        
        .update-info { text-align: center; padding: 30px 0; color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 50px; height: 50px; border: 2px solid #222; border-top-color: #1E6FFF; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* ì‹¤ì‹œê°„ ì•Œë¦¼ */
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #111; border: 1px solid #1E6FFF; color: #fff; font-size: 14px; z-index: 1000; animation: slideIn 0.3s; display: none; }
        .notification.show { display: block; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        @media (max-width: 768px) {
            .control-bar { flex-direction: column; }
            .podium { flex-direction: column; height: auto; gap: 30px; }
            .podium-item.rank-2, .podium-item.rank-3 { margin-top: 0; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SNSì„¼í„° <span>ë„ì›€ ì¹´ìš´íŒ… í”„ë¡œê·¸ë¨</span></h1>
            <div class="date-display" id="dateDisplay"></div>
            <div class="today-info">ì˜¤ëŠ˜ í•˜ë£¨ (00:00 - 23:59) ì‹¤ì‹œê°„ ì§‘ê³„</div>
        </div>
        
        <!-- í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-title" id="progressTitle">ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-info">
                <span id="progressCurrent">0</span>
                <span id="progressPercent">0%</span>
                <span id="progressTotal">0</span>
            </div>
        </div>
        
        <div class="control-bar">
            <div class="control-buttons">
                <button class="btn primary" onclick="quickSync()" id="quickSyncBtn">ë¹ ë¥¸ ìƒˆë¡œê³ ì¹¨</button>
                <button class="btn" onclick="fullSync()" id="fullSyncBtn">ì „ì²´ ë™ê¸°í™”</button>
                <button class="btn" onclick="toggleAuto()" id="autoBtn">ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘</button>
                <button class="btn" onclick="analyzeData()" id="analyzeBtn">ë°ì´í„° ë¶„ì„</button>
            </div>
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">ëŒ€ê¸° ì¤‘</span>
                <span id="lastUpdate" style="margin-left: 20px; color: #666;"></span>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card" id="card-helps">
                <div class="stat-value" id="totalHelps">0</div>
                <div class="stat-label">ì˜¤ëŠ˜ ë„ì›€ íšŸìˆ˜</div>
                <div class="stat-change" id="helpsChange"></div>
            </div>
            <div class="stat-card" id="card-chars">
                <div class="stat-value" id="totalChars">0</div>
                <div class="stat-label">ì˜¤ëŠ˜ ì´ ê¸€ììˆ˜</div>
                <div class="stat-change" id="charsChange"></div>
            </div>
            <div class="stat-card" id="card-counselors">
                <div class="stat-value" id="activeCounselors">0</div>
                <div class="stat-label">ì˜¤ëŠ˜ ì°¸ì—¬ ìƒë‹´ì‚¬</div>
                <div class="stat-change" id="counselorsChange"></div>
            </div>
            <div class="stat-card" id="card-avg">
                <div class="stat-value" id="avgChars">0</div>
                <div class="stat-label">í‰ê·  ê¸€ììˆ˜</div>
                <div class="stat-change" id="avgChange"></div>
            </div>
        </div>
        
        <div class="podium" id="podium"></div>
        
        <div class="ranking-table">
            <div class="table-header">
                <div class="table-title">ì˜¤ëŠ˜ì˜ ìƒë‹´ì‚¬ ë­í‚¹</div>
                <div class="table-count" id="tableCount">0ëª… ì°¸ì—¬</div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ìˆœìœ„</th>
                        <th>ìƒë‹´ì‚¬</th>
                        <th>ë„ì›€ íšŸìˆ˜</th>
                        <th>ì´ ê¸€ììˆ˜</th>
                        <th>í‰ê·  ê¸€ììˆ˜</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="5" style="text-align:center;padding:50px;color:#666;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="update-info" id="updateInfo">ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ëª¨ë“œ</div>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>
    <div class="notification" id="notification"></div>
    
    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://bhtqjipygkawoyieidgp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJodHFqaXB5Z2thd295aWVpZGdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODg5NjgsImV4cCI6MjA3MDA2NDk2OH0.hu2EAj9RCq436QBtfbEVF4aGOau4WWomLMDKahN4iAA';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentData = [];
        let autoInterval = null;
        let lastData = null;
        let isLoading = false;
        let realtimeSubscription = null;
        
        // ì˜¤ëŠ˜ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
        function getTodayRange() {
            const today = new Date();
            const start = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0);
            const end = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
            return {
                startDate: start.toISOString().split('T')[0],
                endDate: end.toISOString().split('T')[0],
                startTime: start.toISOString(),
                endTime: end.toISOString()
            };
        }
        
        // ì´ˆê¸°í™”
        async function init() {
            console.log('ì•± ì´ˆê¸°í™” ì‹œì‘');
            
            // ë‚ ì§œ í‘œì‹œ
            const now = new Date();
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            document.getElementById('dateDisplay').textContent = 
                `${now.getFullYear()}ë…„ ${now.getMonth()+1}ì›” ${now.getDate()}ì¼ ${days[now.getDay()]}ìš”ì¼`;
            
            // í…Œì´ë¸” ì²´í¬
            await checkTables();
            
            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            await quickSync();
            
            // ì‹¤ì‹œê°„ êµ¬ë… ì„¤ì •
            setupRealtimeSubscription();
            
            // ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘í•˜ì§€ ì•ŠìŒ (ìˆ˜ë™ ëª¨ë“œ ê¸°ë³¸)
            // startAutoRefresh();
        }
        
        // í…Œì´ë¸” ì²´í¬ (ìƒì„± ì‹œë„ ì—†ì´)
        async function checkTables() {
            try {
                // í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ë§Œ í™•ì¸
                const { data, error } = await supabase
                    .from('counselor_stats')
                    .select('id')
                    .limit(1);
                
                if (error && error.code === '42P01') {
                    console.log('í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                    showNotification('ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” í•„ìš”', 'error');
                } else {
                    console.log('í…Œì´ë¸” í™•ì¸ ì™„ë£Œ');
                }
            } catch (e) {
                console.log('í…Œì´ë¸” í™•ì¸ ì¤‘ ì˜¤ë¥˜:', e);
            }
        }
        
        // ë¹ ë¥¸ ë™ê¸°í™” (ìºì‹œ ë°ì´í„° ìš°ì„ )
        async function quickSync() {
            if (isLoading) return;
            isLoading = true;
            
            const btn = document.getElementById('quickSyncBtn');
            btn.disabled = true;
            
            setStatus('loading', 'ë¹ ë¥¸ ë™ê¸°í™” ì¤‘...');
            
            try {
                // ë¨¼ì € ìºì‹œëœ ë°ì´í„° ë¡œë“œ
                await loadData();
                
                // ë°±ê·¸ë¼ìš´ë“œì—ì„œ API í˜¸ì¶œ
                if (window.location.hostname !== 'localhost') {
                    fetch('/api/sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(getTodayRange())
                    }).then(() => {
                        loadData(); // API ì‘ë‹µ í›„ ì¬ë¡œë“œ
                    }).catch(console.error);
                }
                
                setStatus('active', 'ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                updateLastTime();
                
            } catch (error) {
                console.error('ë¹ ë¥¸ ë™ê¸°í™” ì‹¤íŒ¨:', error);
                setStatus('error', 'ì˜¤ë¥˜ ë°œìƒ');
            } finally {
                isLoading = false;
                btn.disabled = false;
            }
        }
        
        // ì „ì²´ ë™ê¸°í™” (API í˜¸ì¶œ í›„ ë°ì´í„° ë¡œë“œ)
        async function fullSync() {
            if (isLoading) return;
            isLoading = true;
            
            const btn = document.getElementById('fullSyncBtn');
            btn.disabled = true;
            
            showProgress(true);
            setStatus('loading', 'ì „ì²´ ë™ê¸°í™” ì¤‘...');
            updateProgress('ì±„ë„í†¡ ì—°ê²° ì¤‘...', 0, 100);
            
            const { startDate, endDate } = getTodayRange();
            
            try {
                // API í˜¸ì¶œ ë˜ëŠ” ë°ëª¨ ë°ì´í„° ìƒì„±
                if (window.location.hostname !== 'localhost') {
                    // ì‹¤ì œ API í˜¸ì¶œ
                    updateProgress('ëŒ€í™” ëª©ë¡ ê°€ì ¸ì˜¤ëŠ” ì¤‘...', 20, 100);
                    
                    const response = await fetch('/api/sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ startDate, endDate })
                    });
                    
                    if (!response.ok) throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
                    
                    updateProgress('ë°ì´í„° ì²˜ë¦¬ ì¤‘...', 80, 100);
                    
                } else {
                    // ë°ëª¨ ë°ì´í„° ìƒì„±
                    await generateDemoData(startDate, endDate);
                }
                
                updateProgress('ì™„ë£Œ!', 100, 100);
                await loadData();
                
                setStatus('active', 'ë™ê¸°í™” ì™„ë£Œ');
                updateLastTime();
                showNotification('ì „ì²´ ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
                
                setTimeout(() => showProgress(false), 1000);
                
            } catch (error) {
                console.error('ì „ì²´ ë™ê¸°í™” ì‹¤íŒ¨:', error);
                setStatus('error', 'ë™ê¸°í™” ì‹¤íŒ¨');
                showNotification('ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                showProgress(false);
            } finally {
                isLoading = false;
                btn.disabled = false;
            }
        }
        
        // ë°ëª¨ ë°ì´í„° ìƒì„± (ê°œë°œìš©)
        async function generateDemoData(startDate, endDate) {
            const counselorList = [
                'ì±„ì£¼ì€', 'ì†ì§„ìš°', 'ìœ¤ë„ìš°ë¦¬', 'ì°¨ì •í™˜', 'ì„œë¯¼êµ­',
                'êµ¬ë³¸ì˜', 'ê¶Œì¬í˜„', 'ì¡°ì‹œí˜„', 'ê¹€ìƒì•„', 'ì •ì£¼ì—°',
                'ê¹€ì§€ì›', 'ì •ë‹¤í˜œ', 'ê¹€ì‹œì§„', 'ì‹ í˜œì„œ', 'ì´ë¯¼ì£¼'
            ];
            
            const activeCounselors = Math.floor(Math.random() * 8) + 5;
            const demoData = [];
            
            for (let i = 0; i < activeCounselors; i++) {
                updateProgress(`ìƒë‹´ì‚¬ ${i+1}/${activeCounselors} ì²˜ë¦¬ ì¤‘...`, 20 + (60 * i / activeCounselors), 100);
                
                const counselor = counselorList[i];
                const helpCount = Math.floor(Math.random() * 50) + 10;
                const totalChars = Math.floor(Math.random() * 20000) + 5000;
                
                demoData.push({
                    counselor_id: `52${1200 + i}`,
                    counselor_name: counselor,
                    period_start: startDate,
                    period_end: endDate,
                    help_count: helpCount,
                    total_chars: totalChars,
                    avg_chars: Math.round(totalChars / helpCount),
                    updated_at: new Date().toISOString()
                });
                
                // ì‹¤ì‹œê°„ ëŠë‚Œì„ ìœ„í•´ ì•½ê°„ì˜ ë”œë ˆì´
                await new Promise(r => setTimeout(r, 100));
            }
            
            // ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
            updateProgress('ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì¤‘...', 85, 100);
            
            for (const item of demoData) {
                await supabase.from('counselor_stats').upsert(item, { 
                    onConflict: 'counselor_id,period_start,period_end' 
                });
            }
        }
        
        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            const { startDate, endDate } = getTodayRange();
            
            const { data, error } = await supabase
                .from('counselor_stats')
                .select('*')
                .eq('period_start', startDate)
                .eq('period_end', endDate)
                .order('help_count', { ascending: false });
            
            if (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                return;
            }
            
            if (data) {
                // ë³€í™”ëŸ‰ ê³„ì‚°
                if (currentData.length > 0) {
                    lastData = {
                        totalHelps: currentData.reduce((sum, item) => sum + item.help_count, 0),
                        totalChars: currentData.reduce((sum, item) => sum + item.total_chars, 0),
                        counselors: currentData.length
                    };
                }
                
                currentData = data;
                updateUI();
            }
        }
        
        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            // í†µê³„ ê³„ì‚°
            const totalHelps = currentData.reduce((sum, item) => sum + item.help_count, 0);
            const totalChars = currentData.reduce((sum, item) => sum + item.total_chars, 0);
            const avgChars = totalHelps > 0 ? Math.round(totalChars / totalHelps) : 0;
            
            // ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜
            ['helps', 'chars', 'counselors', 'avg'].forEach(type => {
                document.getElementById(`card-${type}`).classList.add('updating');
                setTimeout(() => {
                    document.getElementById(`card-${type}`).classList.remove('updating');
                }, 500);
            });
            
            // ìˆ«ì ì—…ë°ì´íŠ¸
            animateNumber('totalHelps', totalHelps);
            animateNumber('totalChars', totalChars);
            animateNumber('activeCounselors', currentData.length);
            animateNumber('avgChars', avgChars);
            
            // ë³€í™”ëŸ‰ í‘œì‹œ
            if (lastData) {
                const helpsChange = totalHelps - lastData.totalHelps;
                const charsChange = totalChars - lastData.totalChars;
                const counselorsChange = currentData.length - lastData.counselors;
                
                updateChange('helpsChange', helpsChange);
                updateChange('charsChange', charsChange);
                updateChange('counselorsChange', counselorsChange);
            }
            
            // í¬ë””ì›€ ì—…ë°ì´íŠ¸
            updatePodium();
            
            // í…Œì´ë¸” ì—…ë°ì´íŠ¸
            updateTable();
            
            // ì°¸ì—¬ì ìˆ˜ ì—…ë°ì´íŠ¸
            document.getElementById('tableCount').textContent = `${currentData.length}ëª… ì°¸ì—¬`;
        }
        
        // í¬ë””ì›€ ì—…ë°ì´íŠ¸
        function updatePodium() {
            const podium = document.getElementById('podium');
            const top3 = currentData.slice(0, 3);
            
            if (top3.length === 0) {
                podium.innerHTML = '';
                podium.classList.remove('show');
                return;
            }
            
            const order = top3.length >= 2 ? [1, 0, 2] : [0, 1, 2]; // 2ë“±, 1ë“±, 3ë“± ìˆœì„œ
            podium.innerHTML = order.map(idx => {
                if (!top3[idx]) return '';
                const item = top3[idx];
                const rank = idx + 1;
                return `
                    <div class="podium-item rank-${rank}">
                        <div class="podium-rank">${rank}</div>
                        <div class="podium-bar">
                            <div class="podium-content">
                                <div class="podium-name">${item.counselor_name}</div>
                                <div class="podium-helps">${item.help_count}</div>
                                <div class="podium-chars">${item.total_chars.toLocaleString()} ê¸€ì</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            setTimeout(() => podium.classList.add('show'), 100);
        }
        
        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            
            if (currentData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:50px;color:#666;">ì˜¤ëŠ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            const oldRows = tbody.querySelectorAll('tr');
            const oldIds = Array.from(oldRows).map(row => row.dataset.id);
            
            tbody.innerHTML = currentData.map((item, index) => {
                const rank = index + 1;
                let rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
                const isNew = !oldIds.includes(item.counselor_id);
                
                return `
                    <tr data-id="${item.counselor_id}" class="${isNew ? 'new-entry' : ''}">
                        <td><span class="rank-number ${rankClass}">${rank}</span></td>
                        <td>${item.counselor_name}<br><small style="color:#666">${item.counselor_id}</small></td>
                        <td>${item.help_count.toLocaleString()}</td>
                        <td>${item.total_chars.toLocaleString()}</td>
                        <td>${item.avg_chars.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // ìˆ«ì ì• ë‹ˆë©”ì´ì…˜
        function animateNumber(id, target) {
            const element = document.getElementById(id);
            const start = parseInt(element.textContent.replace(/,/g, '')) || 0;
            const duration = 800;
            const startTime = Date.now();
            
            function update() {
                const progress = Math.min((Date.now() - startTime) / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 3); // ease-out cubic
                const current = Math.floor(start + (target - start) * easeProgress);
                element.textContent = current.toLocaleString();
                if (progress < 1) requestAnimationFrame(update);
            }
            update();
        }
        
        // ë³€í™”ëŸ‰ ì—…ë°ì´íŠ¸
        function updateChange(id, value) {
            const element = document.getElementById(id);
            if (value > 0) {
                element.textContent = `+${value.toLocaleString()}`;
                element.className = 'stat-change';
            } else if (value < 0) {
                element.textContent = value.toLocaleString();
                element.className = 'stat-change down';
            } else {
                element.textContent = '';
            }
        }
        
        // í”„ë¡œê·¸ë ˆìŠ¤ ë°”
        function showProgress(show) {
            document.getElementById('progressContainer').classList.toggle('active', show);
        }
        
        function updateProgress(title, current, total) {
            document.getElementById('progressTitle').textContent = title;
            document.getElementById('progressCurrent').textContent = current;
            document.getElementById('progressTotal').textContent = total;
            const percent = Math.round((current / total) * 100);
            document.getElementById('progressPercent').textContent = `${percent}%`;
            document.getElementById('progressFill').style.width = `${percent}%`;
        }
        
        // ìƒíƒœ í‘œì‹œ
        function setStatus(type, text) {
            document.getElementById('statusDot').className = 'status-dot ' + type;
            document.getElementById('statusText').textContent = text;
        }
        
        // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
        function updateLastTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
        }
        
        // ì•Œë¦¼ í‘œì‹œ
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.borderColor = type === 'error' ? '#FF0000' : '#1E6FFF';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // ì‹¤ì‹œê°„ êµ¬ë… ì„¤ì •
        function setupRealtimeSubscription() {
            // ê¸°ì¡´ êµ¬ë… í•´ì œ
            if (realtimeSubscription) {
                supabase.removeChannel(realtimeSubscription);
            }
            
            // ìƒˆ êµ¬ë… ì„¤ì •
            realtimeSubscription = supabase
                .channel('stats-changes')
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'counselor_stats' 
                }, (payload) => {
                    console.log('ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸:', payload);
                    
                    // ì˜¤ëŠ˜ ë°ì´í„°ì¸ì§€ í™•ì¸
                    const { startDate } = getTodayRange();
                    if (payload.new && payload.new.period_start === startDate) {
                        loadData();
                        showNotification('ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');
                    }
                })
                .subscribe();
        }
        
        // ìë™ ìƒˆë¡œê³ ì¹¨
        function startAutoRefresh() {
            if (!autoInterval) {
                autoInterval = setInterval(() => {
                    if (!isLoading) {
                        quickSync();
                    }
                }, 30000); // 30ì´ˆë§ˆë‹¤
                
                document.getElementById('autoBtn').textContent = 'ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€';
                setStatus('active', 'ìë™ ëª¨ë“œ (30ì´ˆ)');
                document.getElementById('updateInfo').textContent = 'ìë™ìœ¼ë¡œ 30ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤';
            }
        }
        
        function toggleAuto() {
            const btn = document.getElementById('autoBtn');
            if (autoInterval) {
                clearInterval(autoInterval);
                autoInterval = null;
                btn.textContent = 'ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘';
                setStatus('active', 'ìˆ˜ë™ ëª¨ë“œ');
                document.getElementById('updateInfo').textContent = 'ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ëª¨ë“œ';
            } else {
                startAutoRefresh();
            }
        }
        
        // ìì • ë¦¬ì…‹
        setInterval(() => {
            const now = new Date();
            if (now.getHours() === 0 && now.getMinutes() === 0) {
                currentData = [];
                lastData = null;
                init();
            }
        }, 60000);
        
        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ê°ì§€
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì´ë©´ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                quickSync();
            }
        });
        
        // ë°ì´í„° ìì²´ ë¶„ì„
        async function analyzeData() {
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            setStatus('loading', 'ë°ì´í„° ë¶„ì„ ì¤‘...');
            
            try {
                const { startDate, endDate } = getTodayRange();
                
                // ë°ì´í„° ë¡œë“œ
                const { data, error } = await supabase
                    .from('counselor_stats')
                    .select('*')
                    .eq('period_start', startDate)
                    .eq('period_end', endDate);
                
                if (error) throw error;
                if (!data || data.length === 0) {
                    showNotification('ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                
                // ë¶„ì„ ìˆ˜í–‰
                let anomalies = [];
                let warnings = [];
                let unknownCount = 0;
                let duplicateNames = new Map();
                
                data.forEach(item => {
                    // Unknown ì²´í¬
                    if (item.counselor_name.includes('Unknown') || item.counselor_name.includes('ë¯¸í™•ì¸')) {
                        unknownCount++;
                        anomalies.push(`Unknown ID: ${item.counselor_id}`);
                    }
                    
                    // ë¹„ì •ìƒ ë„ì›€ íšŸìˆ˜ ì²´í¬
                    if (item.help_count > 200) {
                        anomalies.push(`${item.counselor_name}: ë„ì›€ ${item.help_count}íšŒ (ë¹„ì •ìƒì ìœ¼ë¡œ ë§ìŒ)`);
                    }
                    
                    // ë¹„ì •ìƒ ê¸€ììˆ˜ ì²´í¬
                    if (item.avg_chars > 5000) {
                        anomalies.push(`${item.counselor_name}: í‰ê·  ${item.avg_chars}ì (ë¹„ì •ìƒì ìœ¼ë¡œ ë§ìŒ)`);
                    }
                    
                    // ì¤‘ë³µ ì´ë¦„ ì²´í¬
                    if (!duplicateNames.has(item.counselor_name)) {
                        duplicateNames.set(item.counselor_name, []);
                    }
                    duplicateNames.get(item.counselor_name).push(item.counselor_id);
                });
                
                // ì¤‘ë³µ ID ê²½ê³ 
                duplicateNames.forEach((ids, name) => {
                    if (ids.length > 1) {
                        warnings.push(`${name}: ì—¬ëŸ¬ ID ì‚¬ìš© (${ids.join(', ')})`);
                    }
                });
                
                // í†µê³„ ê³„ì‚°
                const totalHelps = data.reduce((sum, item) => sum + item.help_count, 0);
                const avgHelpsPerCounselor = Math.round(totalHelps / data.length);
                const maxHelps = Math.max(...data.map(item => item.help_count));
                const minHelps = Math.min(...data.map(item => item.help_count));
                
                // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                let analysisHTML = '<div style="padding: 20px; background: #111; border: 1px solid #222; margin: 20px 0;">';
                analysisHTML += '<h3 style="color: #1E6FFF; margin-bottom: 15px;">ğŸ“Š ë°ì´í„° í’ˆì§ˆ ë¶„ì„ ê²°ê³¼</h3>';
                
                // í†µê³„
                analysisHTML += '<div style="margin-bottom: 20px;">';
                analysisHTML += `<p>ì´ ìƒë‹´ì‚¬: ${data.length}ëª…</p>`;
                analysisHTML += `<p>ì´ ë„ì›€ íšŸìˆ˜: ${totalHelps.toLocaleString()}íšŒ</p>`;
                analysisHTML += `<p>í‰ê·  ë„ì›€ íšŸìˆ˜: ${avgHelpsPerCounselor}íšŒ</p>`;
                analysisHTML += `<p>ìµœëŒ€/ìµœì†Œ: ${maxHelps}íšŒ / ${minHelps}íšŒ</p>`;
                analysisHTML += '</div>';
                
                // ì´ìƒ ì§•í›„
                if (anomalies.length > 0) {
                    analysisHTML += '<div style="margin-bottom: 20px;">';
                    analysisHTML += '<h4 style="color: #FF0000;">âš ï¸ ì´ìƒ ì§•í›„ ë°œê²¬ (' + anomalies.length + 'ê±´)</h4>';
                    analysisHTML += '<ul style="color: #FF6666; font-size: 12px;">';
                    anomalies.slice(0, 5).forEach(a => {
                        analysisHTML += `<li>${a}</li>`;
                    });
                    if (anomalies.length > 5) {
                        analysisHTML += `<li>... ì™¸ ${anomalies.length - 5}ê±´</li>`;
                    }
                    analysisHTML += '</ul>';
                    analysisHTML += '</div>';
                }
                
                // ê²½ê³ 
                if (warnings.length > 0) {
                    analysisHTML += '<div style="margin-bottom: 20px;">';
                    analysisHTML += '<h4 style="color: #FFA500;">âš¡ ê²½ê³  (' + warnings.length + 'ê±´)</h4>';
                    analysisHTML += '<ul style="color: #FFB366; font-size: 12px;">';
                    warnings.slice(0, 5).forEach(w => {
                        analysisHTML += `<li>${w}</li>`;
                    });
                    analysisHTML += '</ul>';
                    analysisHTML += '</div>';
                }
                
                // ë°ì´í„° í’ˆì§ˆ ì ìˆ˜
                const qualityScore = Math.max(0, 100 - (anomalies.length * 5) - (warnings.length * 2) - (unknownCount * 10));
                analysisHTML += '<div>';
                analysisHTML += '<h4>ë°ì´í„° í’ˆì§ˆ ì ìˆ˜</h4>';
                analysisHTML += `<div style="width: 100%; height: 20px; background: #222; position: relative;">`;
                analysisHTML += `<div style="width: ${qualityScore}%; height: 100%; background: ${qualityScore > 70 ? '#00FF00' : qualityScore > 40 ? '#FFA500' : '#FF0000'};"></div>`;
                analysisHTML += `</div>`;
                analysisHTML += `<p style="text-align: center; margin-top: 10px;">${qualityScore}ì  / 100ì </p>`;
                analysisHTML += '</div>';
                
                analysisHTML += '</div>';
                
                // ê²°ê³¼ë¥¼ ìƒˆ ì°½ì— í‘œì‹œ
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                modal.innerHTML = `
                    <div style="max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; background: #000; border: 1px solid #1E6FFF; padding: 20px;">
                        ${analysisHTML}
                        <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; padding: 10px; background: #1E6FFF; color: #000; border: none; cursor: pointer; margin-top: 20px;">ë‹«ê¸°</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                setStatus('active', 'ë¶„ì„ ì™„ë£Œ');
                
            } catch (error) {
                console.error('ë¶„ì„ ì‹¤íŒ¨:', error);
                showNotification('ë°ì´í„° ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                setStatus('error', 'ë¶„ì„ ì‹¤íŒ¨');
            } finally {
                btn.disabled = false;
            }
        }
        
        // ì‹œì‘
        init();
    </script>
</body>
</html>
